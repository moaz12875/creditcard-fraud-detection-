# -*- coding: utf-8 -*-
"""Untitled32.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15cAsIm2j6Q6PeZjzxg2sWut9xDSLHJpS
"""

import gradio as gr
import pandas as pd
import numpy as np
import joblib

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
model = joblib.load("xgb_credit_model.pkl")

def predict_fraud(country, ttype, amount, time):
    # input Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„
    input_data = pd.DataFrame([[time, amount] + [0]*28], columns=model.get_booster().feature_names)

    # predict
    pred = model.predict(input_data)[0]
    prob = float(model.predict_proba(input_data)[0][1]) if hasattr(model, "predict_proba") else (1.0 if pred==1 else 0.0)

    # Ø¬Ø¯ÙˆÙ„ HTML Ù…Ù†Ø³Ù‚ Ù…Ø¹ Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„
    if prob < 0.3:
        row_color = "#d4edda"  # Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
    elif prob < 0.7:
        row_color = "#fff3cd"  # Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­
    else:
        row_color = "#f8d7da"  # Ø£Ø­Ù…Ø± ÙØ§ØªØ­

    table_html = f"""
    <table style="width:60%; border-collapse: collapse; margin-bottom:10px;">
      <tr style="background-color:#f2f2f2;">
        <th style="border:1px solid #ddd; padding:8px;">Feature</th>
        <th style="border:1px solid #ddd; padding:8px;">Value</th>
      </tr>
      <tr style="background-color:{row_color};">
        <td style="border:1px solid #ddd; padding:8px;">Country</td>
        <td style="border:1px solid #ddd; padding:8px;">{country}</td>
      </tr>
      <tr style="background-color:{row_color};">
        <td style="border:1px solid #ddd; padding:8px;">Type Transaction</td>
        <td style="border:1px solid #ddd; padding:8px;">{ttype}</td>
      </tr>
      <tr style="background-color:{row_color};">
        <td style="border:1px solid #ddd; padding:8px;">Amount</td>
        <td style="border:1px solid #ddd; padding:8px;">{amount}</td>
      </tr>
      <tr style="background-color:{row_color};">
        <td style="border:1px solid #ddd; padding:8px;">Time</td>
        <td style="border:1px solid #ddd; padding:8px;">{time}</td>
      </tr>
    </table>
    """

    # Ø´Ø±ÙŠØ· probability gradient Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    meter_html = f"""
    <label for="fraudMeter">Fraud Probability:</label>
    <div style="background:#eee; width:50%; height:30px; border-radius:5px; overflow:hidden;">
        <div style="width:{prob*100}%; height:100%; background:linear-gradient(to right, green, orange, red);"></div>
    </div>
    <span style="margin-left:10px; font-weight:bold;">{prob*100:.2f}%</span>
    <br><br>
    """

    # 6 if logic ÙˆØ§Ù‚Ø¹ÙŠØ©
    if amount > 5000 and time < 1000:
        msg = "<p style='color:red'>ğŸš¨ Ø¹Ù…Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ ÙÙŠ ÙˆÙ‚Øª ØºÙŠØ± Ù…Ø¹ØªØ§Ø¯!</p>"
    elif amount > 3000 and time < 2000:
        msg = "<p style='color:orange'>âš ï¸ Ø¹Ù…Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© ÙÙŠ ÙˆÙ‚Øª Ù…Ø¨ÙƒØ± Ù…Ù† Ø§Ù„ÙŠÙˆÙ….</p>"
    elif amount > 1000 and time > 80000:
        msg = "<p style='color:orange'>âš ï¸ Ø¹Ù…Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© ÙÙŠ ÙˆÙ‚Øª Ù…ØªØ£Ø®Ø± Ù…Ù† Ø§Ù„ÙŠÙˆÙ….</p>"
    elif amount < 50 and time > 80000:
        msg = "<p style='color:green'>âœ… Ø¹Ù…Ù„ÙŠØ© ØµØºÙŠØ±Ø© ÙÙŠ ÙˆÙ‚Øª Ù…ØªØ£Ø®Ø±ØŒ ØªØ¨Ø¯Ùˆ Ø·Ø¨ÙŠØ¹ÙŠØ©.</p>"
    elif amount < 500 and time < 5000:
        msg = "<p style='color:green'>âœ… Ø¹Ù…Ù„ÙŠØ© ØµØºÙŠØ±Ø© ÙÙŠ ÙˆÙ‚Øª Ù…Ø¨ÙƒØ±ØŒ ØªØ¨Ø¯Ùˆ Ø·Ø¨ÙŠØ¹ÙŠØ©.</p>"
    elif amount > 2000 and 20000 < time < 60000:
        msg = "<p style='color:orange'>âš ï¸ Ø¹Ù…Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø®Ù„Ø§Ù„ ÙØªØ±Ø© Ù†Ø´Ø·Ø© Ù…Ù† Ø§Ù„ÙŠÙˆÙ….</p>"
    else:
        msg = "<p style='color:blue'>â„¹ï¸ Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­.</p>"

    # if Ù„ÙƒÙ„ Country
    if country == "Other" and prob > 0.6:
        msg += "<p style='color:red'>âŒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Ø¯ÙˆÙ„Ø© ØºÙŠØ± Ù…Ø¹ØªØ§Ø¯Ø© ÙˆØ§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ø­ØªÙŠØ§Ù„ Ù…Ø±ØªÙØ¹Ø©.</p>"
    elif country == "UK" and amount > 3000:
        msg += "<p style='color:orange'>âš ï¸ Ø¹Ù…Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ù…Ù† Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©.</p>"
    elif country == "US" and amount < 50:
        msg += "<p style='color:green'>âœ… Ø¹Ù…Ù„ÙŠØ© ØµØºÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø© ØªØ¨Ø¯Ùˆ Ø¢Ù…Ù†Ø©.</p>"

    # if Ù„ÙƒÙ„ Type Transaction
    if ttype == "Online" and amount > 3000:
        msg += "<p style='color:red'>âš ï¸ Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙƒØ¨ÙŠØ±Ø©.</p>"
    elif ttype == "Credit" and amount > 1000:
        msg += "<p style='color:orange'>âš ï¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ø¦ØªÙ…Ø§Ù†ÙŠØ© ÙƒØ¨ÙŠØ±Ø©.</p>"
    elif ttype == "Offline" and amount < 100:
        msg += "<p style='color:green'>âœ… Ø¹Ù…Ù„ÙŠØ© ØµØºÙŠØ±Ø© Ø£ÙˆÙÙ„Ø§ÙŠÙ† ØªØ¨Ø¯Ùˆ Ø·Ø¨ÙŠØ¹ÙŠØ©.</p>"

    # Mockup Ù„Ø£Ù‡Ù… Features (ØªÙØ³ÙŠØ±)
    top_features = ["V1","V2","V3","Amount","Time"]
    shap_html = "<p><b>Top influencing features:</b> " + ", ".join(top_features) + "</p>"

    output_html = table_html + meter_html + msg + shap_html
    return output_html

iface = gr.Interface(
    fn=predict_fraud,
    inputs=[
        gr.Dropdown(["US","UK","Other"], label="Country"),
        gr.Dropdown(["Online","Credit","Offline"], label="Type Transaction"),
        gr.Slider(0,10000, step=10, label="Amount"),
        gr.Slider(0,86400, step=1, label="Time")
    ],
    outputs=gr.HTML(),
    title="Credit Card Fraud Detection",
    description="Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ³ÙŠØ¸Ù‡Ø± Fraud / Not Fraud Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©."
)

iface.launch()